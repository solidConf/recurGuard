//CVE:CVE-2019-16163
//https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2019-16163
#define NODE_BODY(node)           ((node)->u.base.body)
typedef enum {
    NODE_STRING    =  0,
    NODE_CCLASS    =  1,
    NODE_CTYPE     =  2,
    NODE_BACKREF   =  3,
    NODE_QUANT     =  4,
    NODE_BAG       =  5,
    NODE_ANCHOR    =  6,
    NODE_LIST      =  7,
    NODE_ALT       =  8,
    NODE_CALL      =  9,
    NODE_GIMMICK   = 10
} NodeType;

typedef struct _Node {
    union {
        struct {
            NodeType node_type;
            int status;
            struct _Node* body;
        } base;

        StrNode       str;
        CClassNode    cclass;
        QuantNode     quant;
        BagNode       bag;
        BackRefNode   backref;
        AnchorNode    anchor;
        ConsAltNode   cons;
        CtypeNode     ctype;
        CallNode      call;
        GimmickNode   gimmick;
    } u;
} Node;

static OnigLen
tree_min_len(Node* node, ScanEnv* env)
{
    OnigLen len;
    OnigLen tmin;

    len = 0;
    switch (node.type) {
        case NODE_ALT:
        {
            Node *x, *y;
            y = node;
            do {
                x = NODE_CAR(y);
                tmin = tree_min_len(x, env);
                if (y == node) len = tmin;
                else if (len > tmin) len = tmin;
            } while (IS_NOT_NULL(y = NODE_CDR(y)));
        }
            break;

        case NODE_BAG:
        {
            BagNode* en = BAG_(node);
            switch (en->type) {
                case BAG_MEMORY:
                    if (NODE_IS_MIN_FIXED(node))
                        len = en->min_len;
                    else {
                        if (NODE_IS_MARK1(node))
                            len = 0;  /* recursive */
                        else {
                            NODE_STATUS_ADD(node, MARK1);
                            len = tree_min_len(NODE_BODY(node), env);
                            NODE_STATUS_REMOVE(node, MARK1);

                            en->min_len = len;
                            NODE_STATUS_ADD(node, MIN_FIXED);
                        }
                    }
                    break;

                case BAG_OPTION:
                case BAG_STOP_BACKTRACK:
                    len = tree_min_len(NODE_BODY(node), env);
                    break;
                case BAG_IF_ELSE:
                {
                    OnigLen elen;

                    len = tree_min_len(NODE_BODY(node), env);
                    if (IS_NOT_NULL(en->te.Then))
                        len += tree_min_len(en->te.Then, env);
                    if (IS_NOT_NULL(en->te.Else))
                        elen = tree_min_len(en->te.Else, env);
                    else elen = 0;

                    if (elen < len) len = elen;
                }
                    break;
            }
        }
            break;
            /* fall */
        case NODE_ANCHOR:
        default:
            break;
    }

    return len;
}

