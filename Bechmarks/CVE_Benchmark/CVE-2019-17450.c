//CVE:https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2019-17450

#define TRUE 1
#define NULL 0
#define FALSE 0
#include <stdio.h>
typedef char bfd;
enum dwarf_form {
    FORM_ADDR	= 0x1,
    FORM_REF	= 0x2,
    FORM_BLOCK2	= 0x3,
    FORM_BLOCK4	= 0x4,
    FORM_DATA2	= 0x5,
    FORM_DATA4	= 0x6,
    FORM_DATA8	= 0x7,
    FORM_STRING	= 0x8
};
enum dwarf_attribute {
    AT_name			= (0x0030|FORM_STRING),
    AT_user_def_type		= (0x0070|FORM_REF),
    AT_subscr_data		= (0x00a0|FORM_BLOCK2),
    AT_discr			= (0x0150|FORM_REF),
    AT_discr_value		= (0x0160|FORM_BLOCK2),
    AT_upper_bound_data2	= (0x02f0|FORM_DATA2),
};

unsigned int
non_mangled (int lang)
{
    if(lang) return 1;
    else return 0;
}
struct attr_abbrev
{
    enum dwarf_attribute name;
    enum dwarf_form form;
};




struct dwarf2_debug {
    char *	 alt_dwarf_info_buffer;
    int alt_dwarf_info_size;
};
struct comp_unit
{
    struct dwarf2_debug *stash;
    char *info_ptr_unit;
    char *end_ptr;
    int lang;
};

struct attribute
{
    enum dwarf_attribute name;
    enum dwarf_form form;
    union
    {
        char *str;
        unsigned long val;
    }u;
};

char*
read_alt_indirect_ref (struct comp_unit * unit,
                       int      offset)
{
    return  unit->stash->alt_dwarf_info_buffer + offset;
}

unsigned int
is_str_attr (enum dwarf_form form)
{
    return (form == FORM_STRING || form == FORM_DATA2
            || form == FORM_DATA4 || form == FORM_DATA8);
}
static unsigned int
find_abstract_instance (struct comp_unit*   unit,
                        char *           orig_info_ptr,
                        struct attribute *   attr_ptr,
                        const char **        pname,
                        unsigned int*        is_linkage,
                        char **              filename_ptr,
                        int *                linenumber_ptr)
{

    char *info_ptr;
    char *info_ptr_end;
    unsigned int bytes_read = 0;
    struct abbrev_info *abbrev;
    unsigned int die_ref = attr_ptr->u.val;
//    struct attribute attr = *attr_ptr;
    const char *name = NULL;
    printf("hit 1\n");
    if (attr_ptr->form == FORM_REF)
    {
        info_ptr = read_alt_indirect_ref (unit, die_ref);
        if (info_ptr == NULL)
        {
            return 0;
        }
        info_ptr_end = (unit->stash->alt_dwarf_info_buffer
                        + unit->stash->alt_dwarf_info_size);
    }
    else
    {    printf("hit 2\n");
        unsigned long total;
        info_ptr = unit->info_ptr_unit;
        info_ptr_end = unit->end_ptr;
        info_ptr += die_ref;
    }
        info_ptr += bytes_read;
        printf("hit 3\n");
        switch (attr_ptr->name)
        {
            case AT_name:
                printf("hit 4\n");
                if (name == NULL && is_str_attr (attr_ptr->form))
                {
                    name = attr_ptr->u.str;
                    if (non_mangled (unit->lang))
                        *is_linkage = 1;
                }
                break;
            case AT_user_def_type:
                printf("hit 5\n");
                if (!find_abstract_instance (unit, info_ptr, attr_ptr,
                                             &name, is_linkage,
                                             filename_ptr, linenumber_ptr))
                    return 0;
                break;
            case AT_subscr_data:
            case AT_upper_bound_data2:
                printf("hit 6\n");
                if (is_str_attr (attr_ptr->form))
                {
                    name = attr_ptr->u.str;
                    *is_linkage = 1;
                }
                break;
            case AT_discr:
                printf("hit 7\n");
                    return 0;
                break;
            case AT_discr_value:
                printf("hit 8\n");
                break;
            default:
                printf("hit 9 %d\n", attr_ptr->name);
                break;
        }
    return TRUE;
}

int main() {
    // 初始化变量
    struct dwarf2_debug debug_info;
    debug_info.alt_dwarf_info_buffer = "YourAltDwarfInfoBuffer";
    debug_info.alt_dwarf_info_size = 100;

    struct comp_unit unit;
    unit.stash = &debug_info;

    struct attribute attr;
    attr.name = AT_user_def_type;
    attr.u.val = 1;
    printf("attr.name:%d\n", attr.name);
    attr.form = FORM_STRING;
    attr.u.str = "YourStringValue";
    char *info_ptr = "fafffa\n";
    const char *pname;
    unsigned int is_linkage = 0;
    char *filename_ptr;
    int linenumber_ptr;

    // 调用函数
    int result = find_abstract_instance(&unit,
                                        info_ptr,
                                        &attr,
                                        &pname,
                                        &is_linkage,
                                        &filename_ptr,
                                        &linenumber_ptr);

    // 打印结果
    if (result) {
        return 1;
        // 其他打印结果的代码
    } else {
        return 0;
    }
}